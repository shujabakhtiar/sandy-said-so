generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model User {
  id            String         @id
  email         String         @unique
  name          String?
  createdAt     DateTime       @default(now()) @map("created_at")
  affiliates    Affiliate[]
  gameDecks     GameDeck[]
  orders        Order[]
  people        Person[]
  photos        Photo[]
  subscriptions Subscription[]
  userCredits   UserCredit[]

  @@index([email])
}

model Photo {
  id         Int        @id @default(autoincrement())
  userId     String     @map("user_id")
  imageUrl   String     @map("image_url")
  uploadedAt DateTime   @default(now()) @map("uploaded_at")
  faces      Face[]
  gameCards  GameCard[]
  user       User       @relation(fields: [userId], references: [id])

  @@index([userId])
}

model Face {
  id             Int             @id @default(autoincrement())
  photoId        Int             @map("photo_id")
  boundingBox    Json            @map("bounding_box")
  faceEmbedding  String?         @map("face_embedding")
  photo          Photo           @relation(fields: [photoId], references: [id], onDelete: Cascade)
  facePersonMaps FacePersonMap[]

  @@index([photoId])
}

model Person {
  id             Int             @id @default(autoincrement())
  userId         String          @map("user_id")
  name           String
  note           String?
  createdAt      DateTime        @default(now()) @map("created_at")
  facePersonMaps FacePersonMap[]
  user           User            @relation(fields: [userId], references: [id])

  @@index([userId])
}

model FacePersonMap {
  id       Int    @id @default(autoincrement())
  faceId   Int    @map("face_id")
  personId Int    @map("person_id")
  face     Face   @relation(fields: [faceId], references: [id], onDelete: Cascade)
  person   Person @relation(fields: [personId], references: [id], onDelete: Cascade)

  @@index([faceId])
  @@index([personId])
}

model GameMode {
  id              Int              @id @default(autoincrement())
  name            String           @unique
  currency        String           @default("INR")
  isActive        Boolean          @default(true)
  price           Int              @default(0)
  gameDecks       GameDeck[]
  orderItems      OrderItem[]
  sandyChaosCards SandyChaosCard[]
}

model GameDeck {
  id            Int            @id @default(autoincrement())
  userId        String         @map("user_id")
  gameModeId    Int            @map("game_mode_id")
  title         String?
  notes         String?
  goal          String?
  secrets       String?
  extra         String?
  chaosLevel    Int            @default(3) @map("chaos_level")
  useImages     Boolean        @default(false) @map("use_images")
  isSaved       Boolean        @default(false) @map("is_saved")
  createdAt     DateTime       @default(now()) @map("created_at")
  aiGenerations AiGeneration[]
  gameCards     GameCard[]
  gameMode      GameMode       @relation(fields: [gameModeId], references: [id])
  user          User           @relation(fields: [userId], references: [id])
  orderItems    OrderItem[]

  @@index([userId])
  @@index([gameModeId])
}

model GameCard {
  id         Int      @id @default(autoincrement())
  deckId     Int      @map("deck_id")
  photoId    Int?     @map("photo_id")
  ruleText   String         @map("rule_text")
  orderIndex Int            @map("order_index")
  isDraft    Boolean        @default(true) @map("is_draft")
  cardType     GameCardType?  @map("card_type")
  targetPerson String?        @map("target_person")
  deck         GameDeck       @relation(fields: [deckId], references: [id], onDelete: Cascade)
  photo      Photo?         @relation(fields: [photoId], references: [id])

  @@index([deckId])
}

model SandyChaosCard {
  id         Int      @id @default(autoincrement())
  gameModeId Int      @map("game_mode_id")
  ruleText   String   @map("rule_text")
  chaosLevel Int      @map("chaos_level")
  gameMode   GameMode @relation(fields: [gameModeId], references: [id])

  @@index([gameModeId])
  @@map("sandy_chaos_cards")
}

model AiGeneration {
  id        Int      @id @default(autoincrement())
  deckId    Int      @map("deck_id")
  prompt    String
  model     String?
  createdAt DateTime @default(now()) @map("created_at")
  deck      GameDeck @relation(fields: [deckId], references: [id], onDelete: Cascade)

  @@index([deckId])
}

model Order {
  id                Int               @id @default(autoincrement())
  deckId            Int?              @map("deck_id")
  customerEmail     String?           @map("customer_email")
  address           String?           @map("address")
  status            String            @default("PENDING")
  createdAt         DateTime          @default(now()) @map("created_at")
  affiliateCode     String?           @map("affiliate_code")
  amount            Int?
  currency          String            @default("INR")
  status_new        PaymentStatus?    @map("payment_status")
  productId         Int?              @map("product_id")
  provider          PaymentProvider   @default(RAZORPAY)
  providerOrderId   String?           @unique @map("provider_order_id")
  providerPaymentId String?           @map("provider_payment_id")
  updatedAt         DateTime          @updatedAt @map("updated_at")
  userId            String?           @map("user_id")
  affiliateEarning  AffiliateEarning?
  affiliate         Affiliate?        @relation(fields: [affiliateCode], references: [code])
  product           Product?          @relation(fields: [productId], references: [id])
  user              User?             @relation(fields: [userId], references: [id])
  items             OrderItem[]
  subscription      Subscription?

  @@index([userId])
  @@index([productId])
  @@index([providerOrderId])
}

model OrderItem {
  id         Int       @id @default(autoincrement())
  orderId    Int       @map("order_id")
  gameModeId Int?      @map("game_mode_id")
  deckId     Int?      @map("deck_id")
  price      Int
  currency   String    @default("INR")
  deck       GameDeck? @relation(fields: [deckId], references: [id])
  gameMode   GameMode? @relation(fields: [gameModeId], references: [id])
  order      Order     @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([orderId])
}

model Product {
  id          Int         @id @default(autoincrement())
  name        String      @unique
  description String?
  type        ProductType
  price       Int
  currency    String      @default("INR")
  isActive    Boolean     @default(true)
  metadata    Json?
  orders      Order[]
}

model Subscription {
  id        Int                @id @default(autoincrement())
  userId    String             @map("user_id")
  orderId   Int                @unique @map("order_id")
  status    SubscriptionStatus @default(ACTIVE)
  startDate DateTime           @default(now()) @map("start_date")
  endDate   DateTime           @map("end_date")
  createdAt DateTime           @default(now()) @map("created_at")
  updatedAt DateTime           @updatedAt @map("updated_at")
  order     Order              @relation(fields: [orderId], references: [id])
  user      User               @relation(fields: [userId], references: [id])

  @@index([userId])
}

model UserCredit {
  id        Int      @id @default(autoincrement())
  userId    String   @map("user_id")
  type      String   @default("DECK_CREDIT")
  balance   Int      @default(0)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  user      User     @relation(fields: [userId], references: [id])

  @@index([userId])
}

model Affiliate {
  id        Int                @id @default(autoincrement())
  code      String             @unique
  userId    String?            @map("user_id")
  createdAt DateTime           @default(now()) @map("created_at")
  user      User?              @relation(fields: [userId], references: [id])
  earnings  AffiliateEarning[]
  orders    Order[]

  @@index([userId])
}

model AffiliateEarning {
  id          Int                   @id @default(autoincrement())
  orderId     Int                   @unique @map("order_id")
  affiliateId Int                   @map("affiliate_id")
  amount      Int
  status      AffiliatePayoutStatus @default(PENDING)
  createdAt   DateTime              @default(now()) @map("created_at")
  affiliate   Affiliate             @relation(fields: [affiliateId], references: [id])
  order       Order                 @relation(fields: [orderId], references: [id])

  @@index([affiliateId])
}

enum ProductType {
  SINGLE_DECK
  BUNDLE
  SUBSCRIPTION
}

enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
}

enum PaymentProvider {
  RAZORPAY
  STRIPE
}

enum SubscriptionStatus {
  ACTIVE
  CANCELED
  EXPIRED
  PAST_DUE
}

enum AffiliatePayoutStatus {
  PENDING
  PAID
}

enum GameCardType {
  PHASE_0
  PHASE_1
  PHASE_2
  PHASE_3
  PHASE_4
  PHASE_5
}
